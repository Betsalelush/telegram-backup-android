name: Build Android APK v3.0

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  # ×’×¨×¡××•×ª ×§×‘×•×¢×•×ª ×œ×× ×™×¢×ª ×”×ª× ×’×©×•×™×•×ª
  PYTHON_VERSION: '3.11'
  BUILDOZER_VERSION: '1.5.0'
  CYTHON_VERSION: '0.29.36'
  ANDROID_API: '33'
  ANDROID_NDK: 'r25c'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 1: ×”×›× ×” ×•×§×•×“
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 2: Cache - ×—×™×¡×›×•×Ÿ ×‘×–××Ÿ!
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ’¾ Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements_full.txt') }}
        restore-keys: |
          pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
          pip-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ runner.os }}-${{ env.BUILDOZER_VERSION }}
        restore-keys: |
          buildozer-global-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}-
          buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-
          buildozer-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Android SDK/NDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android
          /usr/local/lib/android
        key: android-sdk-ndk-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}
        restore-keys: |
          android-sdk-ndk-${{ env.ANDROID_API }}-
          android-sdk-ndk-
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 3: ×”×ª×§× ×ª ×ª×œ×•×™×•×ª ××¢×¨×›×ª
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        echo "ğŸ“¦ ××ª×§×™×Ÿ ×ª×œ×•×™×•×ª ××¢×¨×›×ª..."
        sudo apt-get update -qq
        DEBIAN_FRONTEND=noninteractive sudo apt-get install -y -qq \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          pkg-config \
          pkg-config-macros \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          ccache
        
        echo "âœ… ×ª×œ×•×™×•×ª ××¢×¨×›×ª ×”×•×ª×§× ×•"
        
        # Update autoconf files to fix macro issues
        echo "ğŸ”§ ××¢×“×›×Ÿ autoconf macros..."
        sudo autoupdate || true
        
        echo "âœ… autoconf macros ×¢×•×“×›× ×•"
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 4: ×”×ª×§× ×ª ×ª×œ×•×™×•×ª Python - ×’×¨×¡××•×ª ×§×‘×•×¢×•×ª!
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ Install Python dependencies (Fixed Versions)
      run: |
        echo "ğŸ ××ª×§×™×Ÿ ×ª×œ×•×™×•×ª Python ×¢× ×’×¨×¡××•×ª ×§×‘×•×¢×•×ª..."
        
        # Upgrade pip
        python -m pip install --upgrade pip setuptools wheel
        
        # Install Cython first (required for other packages)
        pip install Cython==${{ env.CYTHON_VERSION }}
        
        # Install Buildozer
        pip install buildozer==${{ env.BUILDOZER_VERSION }}
        
        # Install app requirements (all with fixed versions)
        pip install -r requirements_full.txt
        
        echo "âœ… ×›×œ ×”×ª×œ×•×™×•×ª ×”×•×ª×§× ×• ×‘×’×¨×¡××•×ª ×§×‘×•×¢×•×ª"
        
        # Print versions for verification
        echo "ğŸ“‹ ×’×¨×¡××•×ª ××•×ª×§× ×•×ª:"
        pip list | grep -E "telethon|kivy|kivymd|Cython|buildozer|pyjnius"
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 5: ×”×’×“×¨×•×ª ×¡×‘×™×‘×”
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: âš™ï¸ Configure environment
      run: |
        echo "âš™ï¸ ××’×“×™×¨ ×¡×‘×™×‘×ª build..."
        
        # Set Cython language level
        export CYTHON_LANGUAGE_LEVEL=3
        
        # Set Android environment variables
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        # Create necessary directories
        mkdir -p bin
        mkdir -p .buildozer
        
        echo "âœ… ×¡×‘×™×‘×” ×”×•×’×“×¨×”"
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 6: ×‘× ×™×™×”!
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ”¨ Build APK with Buildozer
      run: |
        echo "ğŸ”¨ ××ª×—×™×œ ×‘× ×™×™×”..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Set environment variables
        export CYTHON_LANGUAGE_LEVEL=3
        export USE_CCACHE=1
        export CCACHE_DIR=~/.ccache
        
        # Run buildozer
        buildozer -v android debug 2>&1 | tee build.log
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ×‘× ×™×™×” ×”×•×©×œ××”!"
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 7: ××™×ª×•×¨ ×•×”×¢×œ××ª APK
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ” Find APK or ZIP
      id: find_apk
      run: |
        echo "ğŸ” ××—×¤×© APK ××• ZIP..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Show current directory
        echo "ğŸ“‚ ×ª×™×§×™×™×” × ×•×›×—×™×ª: $(pwd)"
        
        # List all directories
        echo "ğŸ“‹ ×¨×©×™××ª ×ª×™×§×™×•×ª:"
        ls -la
        
        # Search for APK files everywhere
        echo ""
        echo "ğŸ” ××—×¤×© ×§×‘×¦×™ APK ×‘×›×œ ×”××§×•××•×ª:"
        find . -name "*.apk" -type f 2>/dev/null || echo "×œ× × ××¦××• ×§×‘×¦×™ APK"
        
        # Search for ZIP files
        echo ""
        echo "ğŸ” ××—×¤×© ×§×‘×¦×™ ZIP:"
        find . -name "*.zip" -type f 2>/dev/null || echo "×œ× × ××¦××• ×§×‘×¦×™ ZIP"
        
        # Check bin directory specifically
        echo ""
        echo "ğŸ“‚ ×‘×•×“×§ ×ª×™×§×™×™×ª bin/:"
        if [ -d "bin" ]; then
          ls -la bin/
        else
          echo "×ª×™×§×™×™×ª bin/ ×œ× ×§×™×™××ª"
        fi
        
        # Check .buildozer directory
        echo ""
        echo "ğŸ“‚ ×‘×•×“×§ ×ª×™×§×™×™×ª .buildozer/:"
        if [ -d ".buildozer" ]; then
          find .buildozer -name "*.apk" -o -name "*.zip" 2>/dev/null | head -10
        else
          echo "×ª×™×§×™×™×ª .buildozer/ ×œ× ×§×™×™××ª"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Try to find APK
        APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -n 1)
        
        if [ -n "$APK_PATH" ]; then
          echo "âœ… × ××¦× APK: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "ğŸ“¦ ×’×•×“×œ: $APK_SIZE"
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Try to find ZIP
        ZIP_PATH=$(find . -name "*.zip" -type f 2>/dev/null | head -n 1)
        
        if [ -n "$ZIP_PATH" ]; then
          echo "âœ… × ××¦× ZIP: $ZIP_PATH"
          echo "apk_path=$ZIP_PATH" >> $GITHUB_OUTPUT
          
          ZIP_SIZE=$(du -h "$ZIP_PATH" | cut -f1)
          echo "ğŸ“¦ ×’×•×“×œ: $ZIP_SIZE"
          echo "apk_size=$ZIP_SIZE" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "âŒ APK ××• ZIP ×œ× × ××¦×!"
        exit 1
    
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: telegram-backup-v3.0-${{ github.run_number }}.apk
        path: ${{ steps.find_apk.outputs.apk_path }}
        if-no-files-found: error
        retention-days: 30
    
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ×©×œ×‘ 8: ×¡×™×›×•×
    #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š ×¡×™×›×•× Build"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ Python: ${{ env.PYTHON_VERSION }}"
        echo "ğŸ”¨ Buildozer: ${{ env.BUILDOZER_VERSION }}"
        echo "ğŸ“± Android API: ${{ env.ANDROID_API }}"
        echo "ğŸ”§ NDK: ${{ env.ANDROID_NDK }}"
        echo "ğŸ“¦ APK Size: ${{ steps.find_apk.outputs.apk_size }}"
        echo "ğŸ”¢ Build #: ${{ github.run_number }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: ğŸ“‹ Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.run_number }}.txt
        path: build.log
        if-no-files-found: warn
        retention-days: 7

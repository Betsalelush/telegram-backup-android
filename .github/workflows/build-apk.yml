name: Build Android APK

on:
  # ×”×¤×¢×œ×” ×™×“× ×™×ª ××”×××©×§
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: 'crash_test'
        type: choice
        options:
          - crash_test
          - basic
          - kivymd
          - full
  
  # ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª - ××•×©×‘×ª ×›×“×™ ×œ×× ×•×¢ ×”×¨×¦×•×ª ×›×¤×•×œ×•×ª
  # push:
  #   branches:
  #     - master
  #   paths:
  #     - 'main*.py'
  #     - 'requirements*.txt'
  #     - '.github/workflows/build-apk.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -qq
        DEBIAN_FRONTEND=noninteractive sudo apt-get install -y -qq \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          autoconf-archive \
          m4 \
          pkg-config \
          gettext \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-dev \
          libltdl-dev
    
    
    - name: ğŸ”„ Update autotools macros
      run: |
        echo "ğŸ”„ ××¢×“×›×Ÿ autotools macros..."
        # ×¢×“×›×•×Ÿ autotools ×œ×’×¨×¡××•×ª ××—×¨×•× ×•×ª
        sudo apt-get install --only-upgrade -y autoconf automake libtool
        echo "âœ… autotools ×¢×•×“×›×Ÿ!"
    - name: ğŸ“± Setup Android SDK
      run: |
        set -e  # Exit on error
        echo "ğŸ“± ××ª×§×™×Ÿ Android SDK command-line tools..."
        
        # ×™×¦×™×¨×ª ×ª×™×§×™×•×ª
        SDK_DIR="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$SDK_DIR"
        
        # ×”×•×¨×“×ª command-line tools
        cd "$SDK_DIR"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        rm commandlinetools-linux-11076708_latest.zip
        
        # ××¨×’×•×Ÿ ××‘× ×” ×ª×™×§×™×•×ª - fix the mv command
        mkdir -p cmdline-tools/latest
        # Move contents, not the directory itself, checking each component
        for component in bin lib source.properties NOTICE.txt; do
          if [ -e "cmdline-tools/$component" ]; then
            mv "cmdline-tools/$component" cmdline-tools/latest/ 2>/dev/null || true
          fi
        done
        
        # ×™×¦×™×¨×ª symlink ×œ-tools/bin ×›×“×™ ×©buildozer ×™××¦× ××ª sdkmanager
        mkdir -p tools/bin
        ln -sf ../../cmdline-tools/latest/bin/sdkmanager tools/bin/sdkmanager
        ln -sf ../../cmdline-tools/latest/bin/avdmanager tools/bin/avdmanager
        
        # ×”×’×“×¨×ª ××©×ª× ×™ ×¡×‘×™×‘×”
        echo "ANDROID_SDK_ROOT=$SDK_DIR" >> $GITHUB_ENV
        echo "PATH=$SDK_DIR/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV
        
        # ××™×©×•×¨ ×¨×™×©×™×•× ×•×ª
        mkdir -p licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> licenses/android-sdk-license
        
        echo "âœ… Android SDK ×”×•×ª×§×Ÿ ×‘×”×¦×œ×—×”!"
        echo "ğŸ“ SDK location: $SDK_DIR"
        echo "ğŸ“ sdkmanager location: $(which sdkmanager || echo 'not in PATH')"
    
    
    - name: ğŸ”§ Install Buildozer
      run: |
        pip install --upgrade pip
        pip install --upgrade buildozer python-for-android
        # Use Cython 0.29.36 for better compatibility with pyjnius
        pip install cython==0.29.36
    
    - name: ğŸ”§ Set Cython Language Level
      run: echo "CYTHON_LANGUAGE_LEVEL=3" >> $GITHUB_ENV
    
    - name: ğŸ”§ Configure NDK and Clang
      run: |
        # Set NDK environment variables for compatibility
        echo "ANDROID_NDK_HOME=$HOME/.buildozer/android/platform/android-ndk" >> $GITHUB_ENV
        # Disable unsupported Clang flags
        echo "CFLAGS=-Wno-error=unused-command-line-argument" >> $GITHUB_ENV
        echo "CXXFLAGS=-Wno-error=unused-command-line-argument" >> $GITHUB_ENV
        # Set proper toolchain
        echo "TOOLCHAIN=clang" >> $GITHUB_ENV
        echo "âœ… NDK and Clang environment configured"
    
    
    - name: ğŸ“¦ Upgrade Build Tools
      run: |
        pip install --upgrade setuptools wheel cython
    
    - name: ğŸ“¦ Install and Patch pyjnius
      run: |
        set -e  # Exit on error
        
        echo "ğŸ“¥ Downloading pyjnius..."
        # Use newer version 1.6.1 which has better Cython 3.x compatibility
        pip download pyjnius==1.6.1 --no-deps --dest /tmp --no-binary :all:
        
        # Navigate to temp directory
        pushd /tmp > /dev/null
        
        echo "ğŸ“¦ Extracting pyjnius..."
        # Extract the tar.gz file
        tar -xzf pyjnius-1.6.1.tar.gz
        
        # Navigate to extracted directory
        pushd pyjnius-1.6.1 > /dev/null
        
        echo "ğŸ”§ Patching pyjnius for Python 3 and Cython compatibility..."
        
        # Fix Python 2/3 compatibility - replace 'long' with 'int'
        # Only in Python code, not in C type declarations
        find jnius -type f \( -name "*.pxi" -o -name "*.pyx" -o -name "*.py" \) -exec sed -i \
          -e 's/\bisinstance(\([^,)]*\),\s*long)/isinstance(\1, int)/g' \
          -e 's/\b(int,\s*long)/(int)/g' \
          -e 's/\blong,\s*int\b/int/g' \
          {} + 2>/dev/null || true
        
        # Fix deprecated Cython IF statements if they exist
        # Note: pyjnius 1.6.1 should already be compatible with Cython 3.x
        # But if IF statements exist, we'll convert them to runtime conditionals
        # WARNING: This changes compile-time conditionals to runtime, which may
        # affect performance, but is necessary for Cython 3.x compatibility
        # Limitation: Only catches IF/ELIF/ELSE at line start with optional whitespace
        find jnius -type f \( -name "*.pxi" -o -name "*.pyx" \) -exec sed -i \
          -e 's/^\(\s*\)IF \(.*\):/\1if \2:/g' \
          -e 's/^\(\s*\)ELIF \(.*\):/\1elif \2:/g' \
          -e 's/^\(\s*\)ELSE:/\1else:/g' \
          {} + 2>/dev/null || true
        
        echo "ğŸ“¦ Installing patched pyjnius..."
        pip install . --no-build-isolation
        
        popd > /dev/null
        popd > /dev/null
        
        echo "âœ… pyjnius installed and patched successfully!"
    
    
    - name: ğŸ¯ Select version
      id: get_version
      run: |
        # ×× ×”×•×¤×¢×œ ×™×“× ×™×ª - ×”×©×ª××© ×‘-input
        # ×× ×”×•×¤×¢×œ ××•×˜×•××˜×™×ª - ×”×©×ª××© ×‘-crash_test ×›×‘×¨×™×¨×ª ××—×“×œ
        VERSION="${{ github.event.inputs.version || 'crash_test' }}"
        
        # ×”×’×“×¨×” ×›××©×ª× ×” ×¡×‘×™×‘×” (×œ×¡×§×¨×™×¤×˜×™×)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # ×”×’×“×¨×” ×›-output (×œ×¦×¢×“×™× ××—×¨×™× ×‘-YAML)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Building version: $VERSION"
    
    - name: ğŸ“„ Copy version files
      run: |
        set -e  # Exit on error
        
        # ×©×™××•×© ×‘××©×ª× ×™ ×¡×‘×™×‘×” ×¨×’×™×œ×™×
        VERSION=$VERSION
        
        case $VERSION in
          crash_test)
            if [ -f "old_versions/main_crash_test.py" ]; then
              cp old_versions/main_crash_test.py main.py
            else
              echo "âŒ Error: main_crash_test.py not found"
              exit 1
            fi
            if [ -f "old_versions/requirements_crash_test.txt" ]; then
              cp old_versions/requirements_crash_test.txt requirements.txt
            else
              echo "âŒ Error: requirements_crash_test.txt not found"
              exit 1
            fi
            TITLE="Crash Test"
            PACKAGE="crashtest"
            ;;
          basic)
            if [ -f "old_versions/main_test_basic.py" ]; then
              cp old_versions/main_test_basic.py main.py
            else
              echo "âŒ Error: main_test_basic.py not found"
              exit 1
            fi
            if [ -f "old_versions/requirements_basic.txt" ]; then
              cp old_versions/requirements_basic.txt requirements.txt
            else
              echo "âŒ Error: requirements_basic.txt not found"
              exit 1
            fi
            TITLE="Test Basic"
            PACKAGE="testbasic"
            ;;
          kivymd)
            if [ -f "old_versions/main_test_kivymd.py" ]; then
              cp old_versions/main_test_kivymd.py main.py
            else
              echo "âŒ Error: main_test_kivymd.py not found"
              exit 1
            fi
            if [ -f "old_versions/requirements_kivymd.txt" ]; then
              cp old_versions/requirements_kivymd.txt requirements.txt
            else
              echo "âŒ Error: requirements_kivymd.txt not found"
              exit 1
            fi
            TITLE="Test KivyMD"
            PACKAGE="testkivymd"
            ;;
          full)
            # New modular architecture - use app/main.py
            if [ -f "app/main.py" ]; then
              cp app/main.py main.py
            elif [ -f "old_versions/main_full.py" ]; then
              cp old_versions/main_full.py main.py
            else
              echo "âŒ Error: main.py not found in app/ or old_versions/"
              exit 1
            fi
            if [ -f "requirements_full.txt" ]; then
              cp requirements_full.txt requirements.txt
            else
              echo "âŒ Error: requirements_full.txt not found"
              exit 1
            fi
            TITLE="Telegram Backup"
            PACKAGE="telegrambackup"
            ;;
          *)
            echo "âŒ Error: Unknown version: $VERSION"
            echo "Valid versions: crash_test, basic, kivymd, full"
            exit 1
            ;;
        esac
        
        echo "TITLE=$TITLE" >> $GITHUB_ENV
        echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
        
        echo "âœ… Copied files for version: $VERSION"
        echo "ğŸ“± App title: $TITLE"
        echo "ğŸ“¦ Package: $PACKAGE"
        echo "ğŸ“„ Files copied:"
        ls -lh main.py requirements.txt 2>/dev/null || echo "Warning: Some files may be missing"
    
    
    - name: ğŸ”¨ Create buildozer.spec
      run: |
        VERSION=$VERSION
        TITLE="$TITLE"
        PACKAGE="$PACKAGE"
        
        # ×§×‘×™×¢×ª requirements ×œ×¤×™ ×’×¨×¡×”
        if [ "$VERSION" = "crash_test" ] || [ "$VERSION" = "kivymd" ] || [ "$VERSION" = "full" ]; then
          KIVYMD=",kivymd"
        else
          KIVYMD=""
        fi
        
        if [ "$VERSION" = "full" ]; then
          TELETHON=",telethon,pyaes,rsa,pyasn1,openssl"
        else
          TELETHON=""
        fi
        
        cat > buildozer.spec << EOF
        [app]
        title = $TITLE
        package.name = $PACKAGE
        package.domain = org.backup
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        
        requirements = python3,kivy==2.2.1,sentry-sdk==1.40.0$KIVYMD$TELETHON
        
        orientation = portrait
        fullscreen = 0
        
        android.permissions = INTERNET,ACCESS_NETWORK_STATE
        android.api = 31
        android.minapi = 21
        android.archs = arm64-v8a
        android.accept_sdk_license = True
        android.logcat_filters = *:S python:D kivy:D
        
        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        
        echo "âœ… buildozer.spec created"
    
    - name: ğŸ—ï¸ Build APK with Buildozer
      run: |
        echo "ğŸš€ Starting build..."
        echo "â° This will take 30-40 minutes"
        
        # ××™×©×•×¨ ×¨×™×©×™×•×Ÿ Android SDK ××¨××©
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        
        buildozer -v android debug
    
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        # ×©×™××•×© ×‘-output ××”×¦×¢×“ ×”×§×•×“× ×‘××§×•× env context
        name: apk-${{ steps.get_version.outputs.version }}-${{ github.sha }}
        path: |
          bin/*.apk
          .buildozer/android/platform/build-arm64-v8a/dists/*/bin/*.apk
          .buildozer/android/platform/build-armeabi-v7a/dists/*/bin/*.apk
          **/*.apk
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ‰ Build complete
      run: |
        APK_FILE=$(ls bin/*.apk)
        APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
        echo "âœ… Build completed successfully!"
        echo "ğŸ“¦ APK: $APK_FILE"
        echo "ğŸ“Š Size: $APK_SIZE"
        echo "ğŸ”— Download from: Actions â†’ Artifacts"

name: Build Android APK v3.0

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  # ×’×¨×¡××•×ª ×§×‘×•×¢×•×ª ×œ×× ×™×¢×ª ×”×ª× ×’×©×•×™×•×ª
  PYTHON_VERSION: '3.11'
  BUILDOZER_VERSION: '1.5.0'
  CYTHON_VERSION: '0.29.36'
  ANDROID_API: '33'
  ANDROID_NDK: 'r25c'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ’¾ Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements_full.txt') }}
        restore-keys: |
          pip-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
          pip-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ runner.os }}-${{ env.BUILDOZER_VERSION }}
        restore-keys: |
          buildozer-global-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Buildozer directory
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}-
          buildozer-${{ runner.os }}-${{ env.ANDROID_API }}-
          buildozer-${{ runner.os }}-
    
    - name: ğŸ’¾ Cache Android SDK/NDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android
          /usr/local/lib/android
        key: android-sdk-ndk-${{ env.ANDROID_API }}-${{ env.ANDROID_NDK }}
        restore-keys: |
          android-sdk-ndk-${{ env.ANDROID_API }}-
          android-sdk-ndk-
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        echo "ğŸ“¦ ××ª×§×™×Ÿ ×ª×œ×•×™×•×ª ××¢×¨×›×ª..."
        sudo apt-get update -qq
        DEBIAN_FRONTEND=noninteractive sudo apt-get install -y -qq \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          cmake \
          libffi-dev \
          libssl-dev \
          ccache

        echo "âœ… ×ª×œ×•×™×•×ª ××¢×¨×›×ª ×”×•×ª×§× ×•"
        
        # Update autoconf files to fix macro issues
        echo "ğŸ”§ ××¢×“×›×Ÿ autoconf macros..."
        sudo autoupdate || true
        
        echo "âœ… autoconf macros ×¢×•×“×›× ×• - ×•××•×›× ×™× ×œ×¨×™×¦×”"

    - name: ğŸ Install Python dependencies (Fixed Versions)
      run: |
        echo "ğŸ ××ª×§×™×Ÿ ×ª×œ×•×™×•×ª Python ×¢× ×’×¨×¡××•×ª ×§×‘×•×¢×•×ª..."
        
        python -m pip install --upgrade pip setuptools wheel
        pip install Cython==${{ env.CYTHON_VERSION }}
        pip install buildozer==${{ env.BUILDOZER_VERSION }}
        pip install -r requirements_full.txt
        
        echo "âœ… ×›×œ ×”×ª×œ×•×™×•×ª ×”×•×ª×§× ×•"

    - name: âš™ï¸ Configure environment
      run: |
        echo "âš™ï¸ ××’×“×™×¨ ×¡×‘×™×‘×ª Build..."
        export CYTHON_LANGUAGE_LEVEL=3
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        mkdir -p bin
        mkdir -p .buildozer
        echo "âœ… ×¡×‘×™×‘×” ×”×•×’×“×¨×” ×‘×”×¦×œ×—×”"
    
    - name: ğŸ”¨ Build APK with Buildozer
      run: |
        echo "ğŸ”¨ ××ª×—×™×œ ×ª×”×œ×™×š ×‘× ×™×™×ª APK"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        buildozer -v android debug 2>&1 | tee build.log
        echo "âœ… APK × ×‘× ×” ×‘×”×¦×œ×—×”."

    - name: ğŸ” Find APK or ZIP
      id: find_apk
      run: |
        echo "ğŸ” ××—×¤×© ×§×•×‘×¥ APK ××• ZIP..."
        FILE_PATH=$(find . -type f -name "*.apk" -o -name "*.zip" 2>/dev/null | grep -E "(bin|outputs)" | head -n 1)
        
        if [ -z "$FILE_PATH" ]; then
          echo "âŒ ×§×•×‘×¥ APK ××• ZIP ×œ× × ××¦×!"
          exit 1
        fi
        
        echo "âœ… × ××¦× ×§×•×‘×¥: $FILE_PATH"
        echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
        FILE_SIZE=$(du -h "$FILE_PATH" | cut -f1)
        echo "ğŸ“¦ ×’×•×“×œ ×”×§×•×‘×¥: $FILE_SIZE"
      
    - name: ğŸ“¤ Upload File
      uses: actions/upload-artifact@v4
      with:
        name: telegram-backup-v3.0-${{ github.run_number }}
        path: ${{ steps.find_apk.outputs.file_path }}
        if-no-files-found: error
        retention-days: 30

    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        echo "ğŸ“Š ×¡×™×›×•× Build:"
        echo "ğŸ Python: ${{ env.PYTHON_VERSION }}"
        echo "ğŸ Buildozer Version: ${{ env.BUILDOZER_VERSION }}"

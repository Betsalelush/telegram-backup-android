name: Build Android APK (Docker)

on:
  # ×”×¤×¢×œ×” ×™×“× ×™×ª ×ž×”×ž×ž×©×§
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        default: 'crash_test'
        type: choice
        options:
          - crash_test
          - basic
          - kivymd
          - full

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸŽ¯ Select version
      id: get_version
      run: |
        VERSION="${{ github.event.inputs.version || 'crash_test' }}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Building version: $VERSION"
    
    - name: ðŸ“„ Copy version files
      run: |
        VERSION=$VERSION
        
        case $VERSION in
          crash_test)
            cp legacy/main_crash_test.py main.py
            cp legacy/requirements_crash_test.txt requirements.txt
            TITLE="Crash Test"
            PACKAGE="crashtest"
            ;;
          basic)
            cp legacy/main_test_basic.py main.py
            cp legacy/requirements_basic.txt requirements.txt
            TITLE="Test Basic"
            PACKAGE="testbasic"
            ;;
          kivymd)
            cp legacy/main_test_kivymd.py main.py
            cp legacy/requirements_kivymd.txt requirements.txt
            TITLE="Test KivyMD"
            PACKAGE="testkivymd"
            ;;
          full)
            # New modular architecture - use app/main.py
            cp app/main.py main.py
            cp requirements_full.txt requirements.txt
            TITLE="Telegram Backup"
            PACKAGE="telegrambackup"
            ;;
        esac
        
        echo "TITLE=$TITLE" >> $GITHUB_ENV
        echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
        
        echo "âœ… Copied files for version: $VERSION"
        echo "ðŸ“± App title: $TITLE"
        echo "ðŸ“¦ Package: $PACKAGE"
    
    - name: ðŸ”¨ Create buildozer.spec
      run: |
        VERSION=$VERSION
        TITLE="$TITLE"
        PACKAGE="$PACKAGE"
        
        # ×§×‘×™×¢×ª requirements ×œ×¤×™ ×’×¨×¡×”
        if [ "$VERSION" = "crash_test" ] || [ "$VERSION" = "kivymd" ] || [ "$VERSION" = "full" ]; then
          KIVYMD=",kivymd"
        else
          KIVYMD=""
        fi
        
        if [ "$VERSION" = "full" ]; then
          TELETHON=",telethon,pyaes,rsa,pyasn1,openssl"
        else
          TELETHON=""
        fi
        
        cat > buildozer.spec << EOF
        [app]
        title = $TITLE
        package.name = $PACKAGE
        package.domain = org.backup
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        
        requirements = python3,kivy==2.2.1,sentry-sdk==1.40.0$KIVYMD$TELETHON
        
        orientation = portrait
        fullscreen = 0
        
        android.permissions = INTERNET,ACCESS_NETWORK_STATE
        android.api = 31
        android.minapi = 21
        android.archs = arm64-v8a
        android.accept_sdk_license = True
        android.logcat_filters = *:S python:D kivy:D
        
        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        
        echo "âœ… buildozer.spec created"
    
    - name: ðŸ³ Build APK with Docker (kivy/buildozer)
      run: |
        echo "ðŸ³ Starting Docker build..."
        echo "â° This will take 30-40 minutes"
        echo "ðŸ“¦ Using official kivy/buildozer image"
        
        # ×”×¨×¦×ª buildozer ×‘×ª×•×š Docker container
        docker run --rm \
          -v "$PWD":/home/user/hostcwd \
          -w /home/user/hostcwd \
          kivy/buildozer:latest \
          /bin/bash -c "
            set -eux
            echo 'ðŸ”§ Upgrading buildozer and python-for-android...'
            pip install --upgrade pip
            pip install --upgrade buildozer python-for-android
            
            echo 'ðŸ—ï¸ Building APK...'
            buildozer -v android debug
            
            echo 'âœ… Build completed!'
          "
    
    - name: ðŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ steps.get_version.outputs.version }}-${{ github.sha }}
        path: bin/*.apk
        retention-days: 30
    
    - name: ðŸŽ‰ Build complete
      run: |
        APK_FILE=$(ls bin/*.apk)
        APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
        echo "âœ… Build completed successfully!"
        echo "ðŸ“¦ APK: $APK_FILE"
        echo "ðŸ“Š Size: $APK_SIZE"
        echo "ðŸ”— Download from: Actions â†’ Artifacts"

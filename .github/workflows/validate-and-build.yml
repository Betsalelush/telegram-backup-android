name: Validate and Build

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      build_version:
        description: 'Version to build (optional)'
        required: false
        default: 'full'
        type: choice
        options:
          - crash_test
          - basic
          - kivymd
          - full
  
  # Automatic trigger on pull requests
  pull_request:
    branches:
      - master
  
  # Automatic trigger on push to master
  push:
    branches:
      - master
    paths:
      - 'app/**/*.py'
      - 'legacy/**/*.py'
      - 'main.py'
      - 'requirements*.txt'
      - 'buildozer.spec'

jobs:
  validate:
    name: Validate Functions, Files, and Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install required libraries
      run: |
        echo "ğŸ“¦ Installing required Python libraries..."
        pip install --upgrade pip
        
        # Install core libraries as specified in requirements
        echo "  - Installing Kivy..."
        pip install kivy==2.2.1
        
        echo "  - Installing KivyMD..."
        pip install kivymd
        
        echo "  - Installing Telethon..."
        pip install telethon
        
        echo "  - Installing Sentry SDK..."
        pip install sentry-sdk
        
        # asyncio and json are built-in to Python 3.10+
        echo "  - asyncio: Built-in module âœ“"
        echo "  - json: Built-in module âœ“"
        
        echo "âœ… All required libraries installed!"
    
    - name: ğŸ” Validate main_full.py functions (16+ required)
      run: |
        echo "ğŸ” Validating functions from legacy/main_full.py..."
        
        # List of 16 required functions from main_full.py
        required_functions=(
          "send_code"
          "login"
          "build"
          "start_backup"
          "stop_backup"
          "paste_to_field"
          "log"
          "update_status"
          "update_progress"
          "get_transfer_method"
          "load_progress"
          "save_progress"
          "run_in_worker"
          "smart_delay"
          "get_progress_key"
          "_start_worker_thread"
        )
        
        missing_functions=()
        for func in "${required_functions[@]}"; do
          if ! grep -q "def $func" legacy/main_full.py; then
            missing_functions+=("$func")
            echo "  âŒ Missing: $func"
          else
            echo "  âœ“ Found: $func"
          fi
        done
        
        if [ ${#missing_functions[@]} -gt 0 ]; then
          echo ""
          echo "âŒ Missing ${#missing_functions[@]} required functions from main_full.py"
          exit 1
        fi
        
        echo ""
        echo "âœ… All ${#required_functions[@]} required functions found in main_full.py!"
    
    - name: ğŸ” Validate MASTER_PLAN functions (25+ required)
      run: |
        echo "ğŸ” Validating functions from MASTER_PLAN (managers + screens)..."
        
        # List of 25+ required functions across managers and screens
        required_functions=(
          "add_account"
          "remove_account"
          "get_account"
          "get_all_accounts"
          "save_accounts"
          "load_accounts"
          "get_connected_accounts"
          "get_account_clients"
          "load_progress"
          "save_progress"
          "update_progress"
          "get_sent_message_ids"
          "get_last_message_id"
          "delete_progress"
          "get_stats"
          "increment_message_counter"
          "increment_success_counter"
          "reset_success_counter"
          "smart_delay"
          "get_current_delay_range"
          "send_code"
          "login"
          "disconnect"
          "start_backup"
          "stop_backup"
          "update_status"
          "update_progress"
          "get_transfer_method"
        )
        
        missing_functions=()
        for func in "${required_functions[@]}"; do
          # Search in all Python files under app/
          if ! grep -r "def $func" app/ > /dev/null 2>&1; then
            missing_functions+=("$func")
            echo "  âŒ Missing: $func"
          else
            echo "  âœ“ Found: $func"
          fi
        done
        
        if [ ${#missing_functions[@]} -gt 0 ]; then
          echo ""
          echo "âŒ Missing ${#missing_functions[@]} required functions from MASTER_PLAN"
          exit 1
        fi
        
        echo ""
        echo "âœ… All ${#required_functions[@]} required functions found in app modules!"
    
    - name: ğŸ“ Verify required files exist
      run: |
        echo "ğŸ“ Verifying all required files exist..."
        
        required_files=(
          "app/main.py"
          "app/config.py"
          "app/__init__.py"
          "app/utils/logger.py"
          "app/utils/helpers.py"
          "app/utils/clipboard.py"
          "app/utils/__init__.py"
          "app/managers/__init__.py"
          "app/managers/account_manager.py"
          "app/managers/progress_manager.py"
          "app/managers/transfer_manager.py"
          "app/screens/__init__.py"
          "app/screens/login_screen.py"
          "app/screens/backup_screen.py"
          "legacy/main_full.py"
          "main.py"
          "requirements_full.txt"
          "buildozer.spec"
          "sentry_logger.py"
          "setup_version.py"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
            echo "  âŒ Missing: $file"
          else
            echo "  âœ“ Found: $file"
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo ""
          echo "âŒ Missing ${#missing_files[@]} required files"
          exit 1
        fi
        
        echo ""
        echo "âœ… All ${#required_files[@]} required files exist!"
    
    - name: ğŸ“‚ Verify required directories exist
      run: |
        echo "ğŸ“‚ Verifying all required directories exist..."
        
        required_dirs=(
          "app"
          "app/kv"
          "app/managers"
          "app/screens"
          "app/utils"
          "data"
          "data/sessions"
          "data/progress"
          "docs"
          "scripts"
          "legacy"
          "tests"
          ".github"
          ".github/workflows"
        )
        
        missing_dirs=()
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            missing_dirs+=("$dir")
            echo "  âŒ Missing: $dir"
          else
            echo "  âœ“ Found: $dir"
          fi
        done
        
        if [ ${#missing_dirs[@]} -gt 0 ]; then
          echo ""
          echo "âŒ Missing ${#missing_dirs[@]} required directories"
          exit 1
        fi
        
        echo ""
        echo "âœ… All ${#required_dirs[@]} required directories exist!"
    
    - name: ğŸ” Validate Python syntax
      run: |
        echo "ğŸ” Validating Python syntax for all files..."
        
        # Test main entry point
        python -m py_compile main.py
        echo "  âœ“ main.py"
        
        # Test app modules
        python -m py_compile app/config.py
        echo "  âœ“ app/config.py"
        python -m py_compile app/main.py
        echo "  âœ“ app/main.py"
        
        # Test managers
        for file in app/managers/*.py; do
          python -m py_compile "$file"
          echo "  âœ“ $file"
        done
        
        # Test screens
        for file in app/screens/*.py; do
          python -m py_compile "$file"
          echo "  âœ“ $file"
        done
        
        # Test utils
        for file in app/utils/*.py; do
          python -m py_compile "$file"
          echo "  âœ“ $file"
        done
        
        # Test legacy files
        python -m py_compile legacy/main_full.py
        echo "  âœ“ legacy/main_full.py"
        
        echo ""
        echo "âœ… All Python files have valid syntax!"
    
    - name: ğŸ§ª Run structure tests
      run: |
        echo "ğŸ§ª Running structure validation tests..."
        python tests/test_structure.py
        echo "âœ… Structure tests passed!"
    
    - name: ğŸ“‹ Generate validation summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… VALIDATION COMPLETE - ALL CHECKS PASSED"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ“ Required libraries installed (Kivy, KivyMD, Telethon, Sentry, asyncio, json)"
        echo "âœ“ 16+ functions validated in legacy/main_full.py"
        echo "âœ“ 25+ functions validated in app modules (MASTER_PLAN)"
        echo "âœ“ All required files verified"
        echo "âœ“ All required directories verified"
        echo "âœ“ Python syntax validation passed"
        echo "âœ“ Structure tests passed"
        echo ""
        echo "ğŸš€ Ready for build!"
  
  build:
    name: Build Android APK
    needs: validate
    runs-on: ubuntu-latest
    # Only run build if manually triggered or if workflow_dispatch with build option
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -qq
        DEBIAN_FRONTEND=noninteractive sudo apt-get install -y -qq \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          autoconf-archive \
          m4 \
          pkg-config \
          gettext \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          cmake \
          libffi-dev \
          libssl-dev \
          python3-dev \
          libltdl-dev
    
    - name: ğŸ”„ Update autotools macros
      run: |
        echo "ğŸ”„ Updating autotools macros..."
        sudo apt-get install --only-upgrade -y autoconf automake libtool
        echo "âœ… autotools updated!"
    
    - name: ğŸ“± Setup Android SDK
      run: |
        echo "ğŸ“± Installing Android SDK command-line tools..."
        
        mkdir -p ~/.buildozer/android/platform/android-sdk
        cd ~/.buildozer/android/platform/android-sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        rm commandlinetools-linux-11076708_latest.zip
        
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        mkdir -p tools/bin
        ln -s ../../cmdline-tools/latest/bin/sdkmanager tools/bin/sdkmanager
        ln -s ../../cmdline-tools/latest/bin/avdmanager tools/bin/avdmanager
        
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "PATH=$HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV
        
        mkdir -p licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> licenses/android-sdk-license
        
        echo "âœ… Android SDK installed!"
    
    - name: ğŸ”§ Install Buildozer
      run: |
        pip install --upgrade pip
        pip install --upgrade buildozer python-for-android
        pip install cython==0.29.33
    
    - name: ğŸ”§ Set Cython Language Level
      run: echo "CYTHON_LANGUAGE_LEVEL=3" >> $GITHUB_ENV
    
    - name: ğŸ“¦ Upgrade Build Tools
      run: |
        pip install --upgrade setuptools wheel cython
    
    - name: ğŸ“¦ Install and Patch pyjnius
      run: |
        echo "ğŸ“¥ Downloading pyjnius..."
        pip download pyjnius==1.5.0 --no-deps --dest /tmp --no-binary :all:
        cd /tmp
        tar -xzf pyjnius-*.tar.gz
        
        extracted_dir=$(find . -maxdepth 1 -type d -name 'pyjnius-*' | head -n 1)
        cd "$extracted_dir"
        
        echo "ğŸ”§ Patching pyjnius files (Python long â†’ int)..."
        find jnius -type f \( -name "*.pxi" -o -name "*.pyx" \) -exec sed -i \
          -e 's/isinstance(\([^,]*\), long)/isinstance(\1, int)/g' \
          -e 's/, long)/, int)/g' \
          -e 's/(long)/(int)/g' \
          -e 's/\[long\]/[int]/g' \
          {} +
        
        echo "ğŸ“¦ Installing patched pyjnius..."
        pip install .
        
        echo "âœ… pyjnius installed and patched!"
    
    - name: ğŸ¯ Select version
      id: get_version
      run: |
        VERSION="${{ github.event.inputs.build_version || 'full' }}"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Building version: $VERSION"
    
    - name: ğŸ“„ Copy version files
      run: |
        VERSION=$VERSION
        
        case $VERSION in
          crash_test)
            cp legacy/main_crash_test.py main.py
            cp legacy/requirements_crash_test.txt requirements.txt
            TITLE="Crash Test"
            PACKAGE="crashtest"
            ;;
          basic)
            cp legacy/main_test_basic.py main.py
            cp legacy/requirements_basic.txt requirements.txt
            TITLE="Test Basic"
            PACKAGE="testbasic"
            ;;
          kivymd)
            cp legacy/main_test_kivymd.py main.py
            cp legacy/requirements_kivymd.txt requirements.txt
            TITLE="Test KivyMD"
            PACKAGE="testkivymd"
            ;;
          full)
            cp app/main.py main.py
            cp requirements_full.txt requirements.txt
            TITLE="Telegram Backup"
            PACKAGE="telegrambackup"
            ;;
        esac
        
        echo "TITLE=$TITLE" >> $GITHUB_ENV
        echo "PACKAGE=$PACKAGE" >> $GITHUB_ENV
        
        echo "âœ… Copied files for version: $VERSION"
        echo "ğŸ“± App title: $TITLE"
        echo "ğŸ“¦ Package: $PACKAGE"
    
    - name: ğŸ”¨ Create buildozer.spec
      run: |
        VERSION=$VERSION
        TITLE="$TITLE"
        PACKAGE="$PACKAGE"
        
        if [ "$VERSION" = "crash_test" ] || [ "$VERSION" = "kivymd" ] || [ "$VERSION" = "full" ]; then
          KIVYMD=",kivymd"
        else
          KIVYMD=""
        fi
        
        if [ "$VERSION" = "full" ]; then
          TELETHON=",telethon,pyaes,rsa,pyasn1,openssl"
        else
          TELETHON=""
        fi
        
        cat > buildozer.spec << EOF
        [app]
        title = $TITLE
        package.name = $PACKAGE
        package.domain = org.backup
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        
        requirements = python3,kivy==2.2.1,sentry-sdk==1.40.0$KIVYMD$TELETHON
        
        orientation = portrait
        fullscreen = 0
        
        android.permissions = INTERNET,ACCESS_NETWORK_STATE
        android.api = 31
        android.minapi = 21
        android.archs = arm64-v8a
        android.accept_sdk_license = True
        android.logcat_filters = *:S python:D kivy:D
        
        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        
        echo "âœ… buildozer.spec created"
    
    - name: ğŸ—ï¸ Build APK with Buildozer
      run: |
        echo "ğŸš€ Starting build..."
        echo "â° This will take 30-40 minutes"
        
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        
        buildozer -v android debug
    
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ steps.get_version.outputs.version }}-${{ github.sha }}
        path: |
          bin/*.apk
          .buildozer/android/platform/build-arm64-v8a/dists/*/bin/*.apk
          .buildozer/android/platform/build-armeabi-v7a/dists/*/bin/*.apk
          **/*.apk
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ‰ Build complete
      run: |
        APK_FILE=$(ls bin/*.apk 2>/dev/null | head -1 || echo "APK not found in bin/")
        if [ -f "$APK_FILE" ]; then
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "âœ… Build completed successfully!"
          echo "ğŸ“¦ APK: $APK_FILE"
          echo "ğŸ“Š Size: $APK_SIZE"
        else
          echo "âš ï¸ Build completed, checking alternative paths..."
          find . -name "*.apk" -type f || echo "No APK files found"
        fi
        echo "ğŸ”— Download from: Actions â†’ Artifacts"

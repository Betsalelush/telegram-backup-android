name: Run Tests

on:
  # Run on pull requests
  pull_request:
    branches:
      - master
    paths:
      - 'app/**/*.py'
      - 'tests/**/*.py'
      - 'requirements*.txt'
      - 'pytest.ini'
      - '.github/workflows/test.yml'
  
  # Run on push to master
  push:
    branches:
      - master
    paths:
      - 'app/**/*.py'
      - 'tests/**/*.py'
      - 'requirements*.txt'
      - 'pytest.ini'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_full.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ” Run linting (syntax check)
      run: |
        echo "ğŸ” Checking Python syntax..."
        python -m py_compile app/__init__.py
        python -m py_compile app/config.py
        python -m py_compile app/main.py
        python -m py_compile app/managers/*.py
        python -m py_compile app/screens/*.py
        python -m py_compile app/utils/*.py
        echo "âœ… All files have valid syntax!"
    
    - name: ğŸ§ª Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        pytest tests/unit/ -v --tb=short
    
    - name: ğŸ”— Run integration tests
      run: |
        echo "ğŸ”— Running integration tests..."
        pytest tests/integration/ -v --tb=short || echo "No integration tests yet"
    
    - name: ğŸ“Š Generate coverage report
      run: |
        echo "ğŸ“Š Generating coverage report..."
        pytest tests/ --cov=app --cov-report=term-missing --cov-report=html
    
    - name: ğŸ“¤ Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-py${{ matrix.python-version }}
        path: htmlcov/
        retention-days: 30
    
    - name: âœ… Tests complete
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All tests passed successfully!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Test summary:"
        echo "  âœ… Syntax validation"
        echo "  âœ… Unit tests"
        echo "  âœ… Integration tests"
        echo "  âœ… Coverage report generated"
